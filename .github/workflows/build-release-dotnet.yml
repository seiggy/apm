name: .NET CI/CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]
    paths-ignore:
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  schedule:
    # Run daily at 04:00 UTC
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      test_build:
        description: 'Test build (uploads as workflow artifacts instead of release assets)'
        required: false
        default: true
        type: boolean

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_DIR: src/apm-dotnet

jobs:
  # Always run tests first with matrix strategy
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
            platform: linux
          - os: ubuntu-24.04-arm
            arch: arm64
            platform: linux
          - os: macos-15-intel
            arch: x86_64
            platform: darwin
          - os: macos-latest
            arch: arm64
            platform: darwin
          - os: windows-latest
            arch: x64
            platform: windows

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Build
        run: dotnet build --no-restore --configuration Release
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal
        working-directory: ${{ env.PROJECT_DIR }}

  # Build NativeAOT binaries + NuGet package
  build:
    name: Build (${{ matrix.artifact }})
    needs: [test]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            rid: linux-x64
            platform: linux
            artifact: apm-linux-x64
          - os: ubuntu-24.04-arm
            rid: linux-arm64
            platform: linux
            artifact: apm-linux-arm64
          - os: macos-15-intel
            rid: osx-x64
            platform: darwin
            artifact: apm-osx-x64
          - os: macos-latest
            rid: osx-arm64
            platform: darwin
            artifact: apm-osx-arm64
          - os: windows-latest
            rid: win-x64
            platform: windows
            artifact: apm-win-x64
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish NativeAOT (${{ matrix.rid }})
        run: >
          dotnet publish src/Apm.Cli/Apm.Cli.csproj
          --configuration Release
          --runtime ${{ matrix.rid }}
          --output ./publish/${{ matrix.artifact }}
          -p:NativeAot=true
          -p:PublishTrimmed=true
          -p:StripSymbols=true
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Create tarball (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd publish
          tar -czf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}
          if command -v sha256sum &> /dev/null; then
            sha256sum ${{ matrix.artifact }}.tar.gz > ${{ matrix.artifact }}.tar.gz.sha256
          elif command -v shasum &> /dev/null; then
            shasum -a 256 ${{ matrix.artifact }}.tar.gz > ${{ matrix.artifact }}.tar.gz.sha256
          fi
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Create zip (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd publish
          Compress-Archive -Path ${{ matrix.artifact }} -DestinationPath ${{ matrix.artifact }}.zip
          $hash = (Get-FileHash ${{ matrix.artifact }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  ${{ matrix.artifact }}.zip" | Out-File -Encoding ascii ${{ matrix.artifact }}.zip.sha256
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ env.PROJECT_DIR }}/publish/${{ matrix.artifact }}.tar.gz
            ${{ env.PROJECT_DIR }}/publish/${{ matrix.artifact }}.tar.gz.sha256
            ${{ env.PROJECT_DIR }}/publish/${{ matrix.artifact }}.zip
            ${{ env.PROJECT_DIR }}/publish/${{ matrix.artifact }}.zip.sha256
            ${{ env.PROJECT_DIR }}/publish/${{ matrix.artifact }}/
          if-no-files-found: error
          retention-days: 30

  # NuGet package (only needs one platform)
  pack-nuget:
    name: Pack NuGet
    needs: [test]
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build Release
        run: dotnet build --configuration Release
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Pack NuGet
        run: dotnet pack --configuration Release --output ./nupkg
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ${{ env.PROJECT_DIR }}/nupkg/*.nupkg
          retention-days: 30

  # Integration tests with binary artifact
  integration-tests:
    name: Integration Tests (${{ matrix.artifact }})
    needs: [test, build]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            artifact: apm-linux-x64
            platform: linux
            binary: apm
          - os: ubuntu-24.04-arm
            artifact: apm-linux-arm64
            platform: linux
            binary: apm
          - os: macos-15-intel
            artifact: apm-osx-x64
            platform: darwin
            binary: apm
          - os: macos-latest
            artifact: apm-osx-arm64
            platform: darwin
            binary: apm
          - os: windows-latest
            artifact: apm-win-x64
            platform: windows
            binary: apm.exe

    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APM binary from build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ./artifact

      - name: Run integration tests (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_MODELS_PAT }}
          GITHUB_APM_PAT: ${{ secrets.GH_CLI_PAT }}
          ADO_APM_PAT: ${{ secrets.ADO_APM_PAT }}
        run: |
          BINARY="./artifact/publish/${{ matrix.artifact }}/${{ matrix.binary }}"
          chmod +x "$BINARY"

          echo "=== Version check ==="
          "$BINARY" --version

          echo "=== Init test project ==="
          mkdir -p /tmp/apm-integration-test
          cd /tmp/apm-integration-test
          "$GITHUB_WORKSPACE/artifact/publish/${{ matrix.artifact }}/${{ matrix.binary }}" init test-project
          cd test-project

          echo "=== Compile dry-run ==="
          "$GITHUB_WORKSPACE/artifact/publish/${{ matrix.artifact }}/${{ matrix.binary }}" compile --dry-run

          echo "=== Integration tests passed ==="
        timeout-minutes: 20

      - name: Run integration tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GH_MODELS_PAT }}
          GITHUB_APM_PAT: ${{ secrets.GH_CLI_PAT }}
          ADO_APM_PAT: ${{ secrets.ADO_APM_PAT }}
        run: |
          $Binary = ".\artifact\publish\${{ matrix.artifact }}\${{ matrix.binary }}"

          Write-Host "=== Version check ==="
          & $Binary --version

          Write-Host "=== Init test project ==="
          $TestDir = Join-Path $env:TEMP "apm-integration-test"
          New-Item -ItemType Directory -Force -Path $TestDir | Out-Null
          Set-Location $TestDir
          & "$env:GITHUB_WORKSPACE\artifact\publish\${{ matrix.artifact }}\${{ matrix.binary }}" init test-project
          Set-Location test-project

          Write-Host "=== Compile dry-run ==="
          & "$env:GITHUB_WORKSPACE\artifact\publish\${{ matrix.artifact }}\${{ matrix.binary }}" compile --dry-run

          Write-Host "=== Integration tests passed ==="
        timeout-minutes: 20

  # Release validation - isolated binary testing without source checkout
  release-validation:
    name: Release Validation (${{ matrix.artifact }})
    needs: [test, build, integration-tests]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            artifact: apm-linux-x64
            platform: linux
            binary: apm
          - os: ubuntu-24.04-arm
            artifact: apm-linux-arm64
            platform: linux
            binary: apm
          - os: macos-15-intel
            artifact: apm-osx-x64
            platform: darwin
            binary: apm
          - os: macos-latest
            artifact: apm-osx-arm64
            platform: darwin
            binary: apm
          - os: windows-latest
            artifact: apm-win-x64
            platform: windows
            binary: apm.exe

    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    steps:
      - name: Set isolated test path
        id: paths
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            echo "isolated_dir=$RUNNER_TEMP/apm-isolated-test" >> $GITHUB_OUTPUT
          else
            echo "isolated_dir=/tmp/apm-isolated-test" >> $GITHUB_OUTPUT
          fi

      - name: Download APM binary from build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ steps.paths.outputs.isolated_dir }}

      - name: Validate binary in isolation (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_MODELS_PAT }}
          GITHUB_APM_PAT: ${{ secrets.GH_CLI_PAT }}
          ADO_APM_PAT: ${{ secrets.ADO_APM_PAT }}
        run: |
          cd "${{ steps.paths.outputs.isolated_dir }}"
          BINARY="./publish/${{ matrix.artifact }}/${{ matrix.binary }}"
          chmod +x "$BINARY"

          echo "=== Verify isolation (no source checkout) ==="
          [ ! -f "pyproject.toml" ] && echo "✅ No source code present" || (echo "❌ Source code found" && exit 1)

          echo "=== Version check ==="
          "$BINARY" --version

          echo "=== Create test project ==="
          "$BINARY" init release-validation-project
          cd release-validation-project

          echo "=== Compile dry-run ==="
          "../$BINARY" compile --dry-run

          echo "=== Release validation passed ==="
        timeout-minutes: 20

      - name: Validate binary in isolation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GH_MODELS_PAT }}
          GITHUB_APM_PAT: ${{ secrets.GH_CLI_PAT }}
          ADO_APM_PAT: ${{ secrets.ADO_APM_PAT }}
        run: |
          $IsolatedDir = "${{ steps.paths.outputs.isolated_dir }}"
          Set-Location $IsolatedDir
          $Binary = Join-Path $IsolatedDir "publish/${{ matrix.artifact }}/${{ matrix.binary }}"

          Write-Host "=== Verify isolation (no source checkout) ==="
          if (Test-Path "pyproject.toml") {
            Write-Host "❌ Source code found"; exit 1
          } else {
            Write-Host "✅ No source code present"
          }

          Write-Host "=== Version check ==="
          & $Binary --version

          Write-Host "=== Create test project ==="
          & $Binary init release-validation-project
          Set-Location release-validation-project

          Write-Host "=== Compile dry-run ==="
          & $Binary compile --dry-run

          Write-Host "=== Release validation passed ==="
        timeout-minutes: 20

  # Publish GitHub Release + NuGet
  publish-release:
    name: Publish GitHub Release & NuGet
    needs: [test, build, pack-nuget, integration-tests, release-validation]
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      is_prerelease: ${{ steps.release_type.outputs.is_prerelease }}
      is_private_repo: ${{ github.event.repository.private }}

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist
          pattern: apm-*
          merge-multiple: false

      - name: Prepare release binaries
        run: |
          echo "Downloaded structure:"
          find ./dist -type f | head -50
          echo ""

          mkdir -p ./release

          # Process Unix artifacts (tar.gz)
          for artifact in apm-linux-x64 apm-linux-arm64 apm-osx-x64 apm-osx-arm64; do
            tarball="./dist/${artifact}/publish/${artifact}.tar.gz"
            checksum="./dist/${artifact}/publish/${artifact}.tar.gz.sha256"
            if [ -f "$tarball" ]; then
              cp "$tarball" "./release/"
              [ -f "$checksum" ] && cp "$checksum" "./release/"
              echo "Prepared ${artifact}.tar.gz"
            else
              echo "ERROR: $tarball not found"
              exit 1
            fi
          done

          # Process Windows artifact (zip)
          for artifact in apm-win-x64; do
            zipfile="./dist/${artifact}/publish/${artifact}.zip"
            checksum="./dist/${artifact}/publish/${artifact}.zip.sha256"
            if [ -f "$zipfile" ]; then
              cp "$zipfile" "./release/"
              [ -f "$checksum" ] && cp "$checksum" "./release/"
              echo "Prepared ${artifact}.zip"
            else
              echo "ERROR: $zipfile not found"
              exit 1
            fi
          done

      - name: Determine release type
        id: release_type
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Detected stable release: $TAG_NAME"
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Detected prerelease: $TAG_NAME"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: ${{ steps.release_type.outputs.is_prerelease == 'true' }}
          files: |
            ./release/*.tar.gz
            ./release/*.tar.gz.sha256
            ./release/*.zip
            ./release/*.zip.sha256

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./nupkg

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Push to NuGet.org
        if: steps.release_type.outputs.is_prerelease == 'false'
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
